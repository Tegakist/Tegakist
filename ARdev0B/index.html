<!DOCTYPE html>
<html>
  <head>
    <title>AR.js with A-Frame and Three.js</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://unpkg.com/three@0.106.2/build/three.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
    <script src="scene-config.js"></script>
    <script src="marker-config.js"></script>
    <script src="object-config.js"></script>
  </head>
  <body>
    <a-scene>
      <a-marker preset="hiro">
        <a-box position="0 0.5 0" material="color: yellow;"></a-box>
      </a-marker>
      <a-entity camera></a-entity>
    </a-scene>
    <div id="version">Ver.24080401105</div>
    <canvas id="camerafeed"></canvas>
    <script>
      // Three.jsの基本設定
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('camerafeed') });
      renderer.setSize(window.innerWidth, window.innerHeight);

      // カメラ映像の取得
      navigator.mediaDevices.getUserMedia({ video: true }).then((stream) => {
        const video = document.createElement('video');
        video.srcObject = stream;
        video.play();

        const videoTexture = new THREE.VideoTexture(video);
        const videoMaterial = new THREE.MeshBasicMaterial({ map: videoTexture });
        const videoGeometry = new THREE.PlaneGeometry(16, 9);
        videoGeometry.scale(0.05, 0.05, 0.05);

        const videoMesh = new THREE.Mesh(videoGeometry, videoMaterial);
        scene.add(videoMesh);

        // オブジェクトの追加
        const boxGeometry = new THREE.BoxGeometry();
        const boxMaterial = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
        const box = new THREE.Mesh(boxGeometry, boxMaterial);
        scene.add(box);

        // マーカーの検出と見失いのシミュレーション
        let markerVisible = false;
        document.querySelector('a-marker').addEventListener('markerFound', () => {
          markerVisible = true;
        });

        document.querySelector('a-marker').addEventListener('markerLost', () => {
          markerVisible = false;
        });

        // アニメーションループ
        function animate() {
          requestAnimationFrame(animate);
          if (!markerVisible) {
            box.visible = true;
          }
          renderer.render(scene, camera);
        }
        animate();
      }).catch((error) => {
        console.error('Error accessing the camera: ', error);
      });
    </script>
  </body>
</html>
