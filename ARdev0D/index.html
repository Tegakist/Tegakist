<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WebXR Sample with MindAR</title>
    <style>
      .version-info {
        position: fixed;
        bottom: 10px;
        right: 10px;
        font-size: 14px;
        color: gray;
        font-family: 'Arial', sans-serif';
      }
      canvas {
        display: block;
      }
    </style>
    <!-- A-Frameの読み込み -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <!-- MindARの読み込み -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <!-- A-Frame Extrasの読み込み -->
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@7.5.1/dist/aframe-extras.min.js"></script>
  </head>
  <body>
    <div class="version-info">Ver.2408182248</div>
    <button id="startButton">Start AR</button>
    <script>
      document.getElementById('startButton').addEventListener('click', () => {
        if (navigator.xr) {
          navigator.xr.requestSession('immersive-ar', { requiredFeatures: ['hit-test'] }).then(onSessionStarted);
        } else {
          console.log('WebXR not supported');
        }
      });

      function onSessionStarted(session) {
        session.addEventListener('end', onSessionEnded);

        let renderer = new THREE.WebGLRenderer({ alpha: true });
        renderer.xr.enabled = true;
        document.body.appendChild(renderer.domElement);

        let scene = new THREE.Scene();
        let camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

        let light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
        light.position.set(0.5, 1, 0.25);
        scene.add(light);

        let loader = new THREE.GLTFLoader();
        loader.load('Logo.glb', function (gltf) {
          let model = gltf.scene;
          model.scale.set(10, 10, 10);
          scene.add(model);
        });

        const mindarThree = new MindARThree({
          container: document.body,
          imageTargetSrc: 'OTK.mind',
        });

        const { renderer: mindarRenderer, scene: mindarScene, camera: mindarCamera } = mindarThree;

        mindarThree.start();

        session.requestReferenceSpace('local').then((refSpace) => {
          renderer.setAnimationLoop((timestamp, frame) => {
            let pose = frame.getViewerPose(refSpace);
            if (pose) {
              let view = pose.views[0];
              let viewport = session.renderState.baseLayer.getViewport(view);
              renderer.setSize(viewport.width, viewport.height);
              camera.matrix.fromArray(view.transform.matrix);
              camera.updateMatrixWorld(true);
              renderer.render(scene, camera);
            }
          });
        });
      }

      function onSessionEnded(event) {
        console.log('Session ended');
      }
    </script>
  </body>
</html>
